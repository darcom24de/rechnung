<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Rechnung – darcom24</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    input, select, button {
      margin: 5px;
    }
    #buttons {
      margin-top: 15px;
    }
  </style>
</head>
<body>

  <h2 style="display: flex; justify-content: space-between; align-items: center;">
    RECHNUNG
    <span id="rechnungsnummer" style="font-size: 1em; font-weight: normal;"></span>
  </h2>

  <div>
    <label>Kunde:</label>
    <input type="text" id="kunde">
    <br>
    <label>Artikelname:</label>
    <input type="text" id="artikelName">
    <label>Einzelpreis (€):</label>
    <input type="number" id="einzelpreis" step="0.01">
    <label>Menge:</label>
    <input type="number" id="menge" value="1">
    <label>MwSt (%):</label>
    <input type="number" id="mwst" value="19">
    <button onclick="addArtikel()">+ Artikel hinzufügen</button>
  </div>

  <table id="artikelTabelle" border="1" cellspacing="0" cellpadding="4">
    <thead>
      <tr>
        <th>Pos</th>
        <th>Artikel</th>
        <th>Menge</th>
        <th>Einzelpreis</th>
        <th>Gesamt</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>

  <div id="buttons">
    <button onclick="generatePDF()">PDF herunterladen</button>
  </div>

  <script>
    let artikelListe = [];
    let aktuelleRechnungsnummer = 1;

    function getNextInvoiceNumber() {
      let lastNumber = localStorage.getItem('rechnungsnummer');
      let nextNumber = lastNumber ? parseInt(lastNumber) + 1 : 1;
      localStorage.setItem('rechnungsnummer', nextNumber);
      aktuelleRechnungsnummer = nextNumber;
      return nextNumber;
    }

    function updateInvoiceNumberDisplay() {
      const number = getNextInvoiceNumber();
      const formatted = 'Nr. ' + number.toString().padStart(4, '0');
      document.getElementById('rechnungsnummer').textContent = formatted;
    }

    function addArtikel() {
      const artikelName = document.getElementById('artikelName').value;
      const einzelpreis = parseFloat(document.getElementById('einzelpreis').value);
      const menge = parseInt(document.getElementById('menge').value) || 1;
      const mwst = parseFloat(document.getElementById('mwst').value) || 0;

      if (!artikelName || isNaN(einzelpreis)) return;

      const gesamt = (einzelpreis * menge).toFixed(2);
      artikelListe.push({ artikelName, menge, einzelpreis, gesamt });

      renderTabelle();
    }

    function renderTabelle() {
      const tbody = document.querySelector("#artikelTabelle tbody");
      tbody.innerHTML = "";

      artikelListe.forEach((artikel, index) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${artikel.artikelName}</td>
          <td>${artikel.menge}</td>
          <td>${artikel.einzelpreis.toFixed(2)} €</td>
          <td>${artikel.gesamt} €</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function generatePDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(18);
      doc.text("RECHNUNG", 14, 20);
      const seitenbreite = doc.internal.pageSize.getWidth();
      const rechnungsnummerText = 'Nr. ' + aktuelleRechnungsnummer.toString().padStart(4, '0');
      doc.setFontSize(12);
      doc.text(rechnungsnummerText, seitenbreite - 40, 20);

      const kunde = document.getElementById("kunde").value;
      doc.text("Kunde: " + kunde, 14, 30);

      const tableData = artikelListe.map((artikel, index) => ([
        (index + 1).toString(),
        artikel.artikelName,
        artikel.menge.toString(),
        artikel.einzelpreis.toFixed(2) + " €",
        artikel.gesamt + " €"
      ]));

      doc.autoTable({
        head: [["Pos", "Artikel", "Menge", "Einzelpreis", "Gesamt"]],
        body: tableData,
        startY: 40
      });

      doc.save(`${kunde || "Rechnung"}_${rechnungsnummerText.replace(' ', '_')}.pdf`);
    }

    window.onload = function () {
      updateInvoiceNumberDisplay();
    };
  </script>
</body>
</html>
