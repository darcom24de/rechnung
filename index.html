<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Rechnung – darcom24</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            padding: 2rem;
            max-width: 800px;
            margin: auto;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        .header img {
            max-width: 150px;
        }
        input, select {
            display: block;
            margin-bottom: 1rem;
            width: 100%;
            padding: 0.5rem;
        }
        button {
            padding: 0.75rem 1rem;
            font-size: 1rem;
            cursor: pointer;
            background-color: black;
            color: white;
            border: none;
            border-radius: 0.5rem;
            margin-right: 0.5rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 0.5rem;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .artikel-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin: 1rem 0;
        }
        .artikel-card {
            border: 1px solid #ccc;
            border-radius: 0.5rem;
            padding: 1rem;
            width: 150px;
            text-align: center;
            cursor: pointer;
        }
        .artikel-card img {
            width: 100%;
            height: auto;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .summe-box {
            text-align: right;
            font-size: 1rem;
            margin-top: 1rem;
        }
        .no-print {
            display: block;
        }
        @media print {
            .no-print {
                display: none !important;
            }
            a[href^="http"] {
                display: none !important;
            }
        }
    </style>
</head>
<body>
<div class="print" style="text-align: left; margin-bottom: 10px;">
    <strong>HC-Shop</strong><br>
    Pankstraße 46<br>
    13357 Berlin<br>
    USt-ID-Nr.: DE353633206
</div>
<div class="header">
    <h2 style="display: flex; justify-content: space-between; align-items: center;">
        RECHNUNG
        <span id="rechnungsnummer" style="font-size: 1em; font-weight: normal;"></span>
    </h2>
    <img src="logo-darcom.png" alt="darcom24 Logo">
</div>

<label for="kunde">Kunde:</label>
<input type="text" id="kunde" placeholder="Kundenname">

<label for="adresse">Adresse:</label>
<input type="text" id="adresse" placeholder="Straße, PLZ, Ort">

<label>Artikel (Pos, Name, Menge, Einzelpreis inkl. MwSt):</label>
<table id="artikelTabelle">
    <thead>
        <tr>
            <th>Pos</th>
            <th>Artikel</th>
            <th>Menge</th>
            <th>Einzelpreis (€)</th>
            <th>Gesamtpreis (€)</th>
            <th></th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<div class="artikel-buttons no-print" id="artikelButtons"></div>

<div class="no-print">
    <button onclick="window.print()">Drucken</button>
    <button id="exportCSV">CSV Export</button>
    <button onclick="downloadPDF()">PDF herunterladen</button>
    <button onclick="addRow()">+ Artikel hinzufügen</button>
</div>

<script>
let artikelListe = [];
let aktuelleRechnungsnummer = 1;

function getNextInvoiceNumber() {
    let lastNumber = localStorage.getItem('rechnungsnummer');
    let nextNumber = lastNumber ? parseInt(lastNumber) + 1 : 1;
    localStorage.setItem('rechnungsnummer', nextNumber);
    aktuelleRechnungsnummer = nextNumber;
    return nextNumber;
}

function updateInvoiceNumberDisplay() {
    const number = getNextInvoiceNumber();
    const formatted = 'Nr. ' + number.toString().padStart(4, '0');
    document.getElementById('rechnungsnummer').textContent = formatted;
}

function addArtikel() {
    const artikelName = document.getElementById('artikelName').value;
    const einzelpreis = parseFloat(document.getElementById('einzelpreis').value);
    const menge = parseInt(document.getElementById('menge').value) || 1;
    const mwst = parseFloat(document.getElementById('mwst').value) || 0;

    if (!artikelName || isNaN(einzelpreis)) return;

    const gesamt = (einzelpreis * menge).toFixed(2);
    artikelListe.push({ artikelName, menge, einzelpreis, gesamt });

    renderTabelle();
}

function renderTabelle() {
    const tbody = document.querySelector("#artikelTabelle tbody");
    tbody.innerHTML = "";

    artikelListe.forEach((artikel, index) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${index + 1}</td>
            <td>${artikel.artikelName}</td>
            <td>${artikel.menge}</td>
            <td>${artikel.einzelpreis.toFixed(2)} €</td>
            <td>${artikel.gesamt} €</td>
        `;
        tbody.appendChild(tr);
    });
}

async function generatePDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.setFontSize(18);
    doc.text("RECHNUNG", 14, 20);

    const seitenbreite = doc.internal.pageSize.getWidth();
    const rechnungsnummerText = 'Nr. ' + aktuelleRechnungsnummer.toString().padStart(4, '0');
    doc.setFontSize(12);
    doc.text(rechnungsnummerText, seitenbreite - 40, 20);

    const kunde = document.getElementById("kunde").value;
    doc.text("Kunde: " + kunde, 14, 30);

    const tableData = artikelListe.map((artikel, index) => ([
        (index + 1).toString(),
        artikel.artikelName,
        artikel.menge.toString(),
        artikel.einzelpreis.toFixed(2) + " €",
        artikel.gesamt + " €"
    ]));

    doc.autoTable({
        head: [["Pos", "Artikel", "Menge", "Einzelpreis", "Gesamt"]],
        body: tableData,
        startY: 40
    });

    doc.save(`${kunde || "Rechnung"}_${rechnungsnummerText.replace(' ', '_')}.pdf`);
}

window.onload = function () {
    updateInvoiceNumberDisplay();
};
</script>

</body>
</html>
